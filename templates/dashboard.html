<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --success-color: #4cc9f0;
      --danger-color: #dc3545;
      --light-bg: #f8f9fa;
    }
    
    body {
      background-color: #f5f7fb;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 16px;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      border: none;
    }
    
    .top-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .stat-box {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 15px;
      border-radius: 8px;
      flex: 1;
      min-width: 200px;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 5px;
    }
    
    .invite-code {
      background-color: #e9ecef;
      border-radius: 5px;
      padding: 10px;
      font-family: monospace;
      display: inline-block;
      margin-right: 10px;
      font-size: 0.9rem;
      word-break: break-all;
    }
    
    input, textarea, button, select {
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      width: 100%;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    button {
      background: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    button:hover:not(:disabled) {
      background: var(--secondary-color);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-copy {
      background: var(--success-color);
      padding: 8px 12px;
      font-size: 0.8rem;
      min-height: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background-color: var(--primary-color);
      color: white;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }
    
    .admin-badge {
      background-color: var(--danger-color);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin-left: 8px;
    }
    
    .member-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }
    
    .member-card {
      background: var(--light-bg);
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
    }
    
    /* Mobile Navigation */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1000;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.2rem;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }
      
      .container {
        padding: 0 10px;
      }
      
      .top-stats {
        flex-direction: column;
        gap: 12px;
      }
      
      .stat-box {
        min-width: 100%;
      }
      
      .card {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .row {
        flex-direction: column;
      }
      
      .col-md-6 {
        width: 100%;
        margin-bottom: 15px;
      }
      
      table {
        font-size: 0.9rem;
      }
      
      th, td {
        padding: 10px 8px;
      }
      
      .member-list {
        grid-template-columns: 1fr;
      }
      
      .mobile-menu-btn {
        display: block;
      }
      
      /* Form elements stack on mobile */
      .form-row {
        flex-direction: column;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      
      .card {
        padding: 12px;
      }
      
      input, textarea, button {
        padding: 10px;
        margin: 6px 0;
      }
      
      th, td {
        padding: 8px 6px;
        font-size: 0.85rem;
      }
      
      .stat-value {
        font-size: 1.3rem;
      }
      
      .invite-code {
        font-size: 0.8rem;
        padding: 8px;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      h3 {
        font-size: 1.2rem;
      }
    }
    
    /* Table responsive wrapper */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" id="mobileMenuBtn">
    <i class="fas fa-bars"></i>
  </button>

  <div class="container">
    <header class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
        <h2 style="margin:0">Dashboard</h2>
        <div style="display:flex;align-items:center;gap:10px">
          <span id="adminBadge" class="admin-badge" style="display: none;">Admin</span>
          <a href="/auth/logout" class="btn-copy" style="text-decoration:none;color:white">
            <i class="fas fa-sign-out-alt"></i> Logout
          </a>
        </div>
      </div>
      <div class="top-stats">
        <div class="stat-box">
          <div>Budget</div>
          <div class="stat-value" id="budget">₹{{ budget }}</div>
        </div>
        <div class="stat-box">
          <div>Total Spent</div>
          <div class="stat-value" id="totalSpent">₹{{ total_spent }}</div>
        </div>
        <div class="stat-box">
          <div>Remaining</div>
          <div class="stat-value" id="remaining">₹{{ remaining }}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;flex-wrap:wrap;gap:10px;margin-top:10px">
        <span class="invite-code" id="inviteCode">{{ invite }}</span>
        <button class="btn-copy" onclick="copyInviteCode()">
          <i class="fas fa-copy"></i> Copy
        </button>
        <span style="font-size:0.9rem">Share with roommates</span>
      </div>
    </header>

    <div class="row" style="display:flex;flex-wrap:wrap;margin:0 -10px">
      <!-- Set Budget (Admin only) -->
      <div style="flex:1;min-width:300px;padding:0 10px;margin-bottom:20px">
        <section class="card">
          <h3 style="display:flex;align-items:center;gap:8px;margin-top:0">
            Set Budget <span class="admin-badge">Admin Only</span>
          </h3>
          <input id="budgetInput" placeholder="Enter budget amount">
          <button id="saveBudgetBtn">Save Budget</button>
        </section>
      </div>
      
      <!-- Household Members -->
      <div style="flex:1;min-width:300px;padding:0 10px;margin-bottom:20px">
        <section class="card">
          <h3 style="margin-top:0">Household Members</h3>
          <div id="membersList" class="member-list">
            <!-- Members will be loaded here -->
          </div>
        </section>
      </div>
    </div>

    <section class="card">
      <h3 style="margin-top:0">Add Expense</h3>
      <input id="item" placeholder="Item">
      <input id="amount" type="number" placeholder="Amount">
      <input id="category" placeholder="Category (optional)">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <div style="flex:1;min-width:150px">
          <input id="date" type="date">
        </div>
        <div style="flex:1;min-width:150px">
          <input id="time" type="time">
        </div>
      </div>
      <button id="addBtn">
        <i class="fas fa-plus"></i> Add Expense
      </button>
    </section>

    <section class="card">
      <h3 style="margin-top:0">Reports</h3>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button onclick="download('daily')" style="flex:1;min-width:120px">
          <i class="fas fa-download"></i> Daily
        </button>
        <button onclick="download('monthly')" style="flex:1;min-width:120px">
          <i class="fas fa-download"></i> Monthly
        </button>
        <button onclick="download('yearly')" style="flex:1;min-width:120px">
          <i class="fas fa-download"></i> Yearly
        </button>
        <button onclick="download('full')" style="flex:1;min-width:120px">
          <i class="fas fa-download"></i> Full
        </button>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">Expenses</h3>
      <div class="table-responsive">
        <table id="table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Amount</th>
              <th>Payer</th>
              <th>Date</th>
              <th>Time</th>
              <th>Shares</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="noExpenses" style="text-align:center;padding:20px;display:none">
        <i class="fas fa-receipt" style="font-size:3rem;color:#ccc;margin-bottom:10px"></i>
        <p style="color:#666;margin:0">No expenses yet. Add your first expense above.</p>
      </div>
    </section>
  </div>

  <!-- Store admin status in a hidden element -->
  <div id="adminStatus" data-is-admin="{{ 'true' if is_admin else 'false' }}" style="display: none;"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // =============================
    // Helper API function
    // =============================
    async function api(path, opts={}) {
      const res = await fetch(path, {
        headers: {
          'Content-Type': 'application/json',
          ...opts.headers
        },
        ...opts
      });
      if (!res.ok) {
        const t = await res.text();
        console.error("API error", res.status, t);
        throw new Error(`API error: ${res.status}`);
      }
      return res.json();
    }

    // Get admin status from hidden element
    const adminStatusElement = document.getElementById('adminStatus');
    const isAdmin = adminStatusElement.getAttribute('data-is-admin') === 'true';

    // =============================
    // On Page Load
    // =============================
    document.addEventListener('DOMContentLoaded', ()=> {
      // Set default date and time
      const now = new Date();
      document.getElementById('date').value = now.toISOString().slice(0,10);
      document.getElementById('time').value = now.toTimeString().slice(0,5);

      // Add event listeners
      document.getElementById('saveBudgetBtn').addEventListener('click', saveBudget);
      document.getElementById('addBtn').addEventListener('click', addExpense);

      // Show admin badge and disable budget controls if not admin
      if (isAdmin) {
        document.getElementById('adminBadge').style.display = 'inline-block';
      } else {
        document.getElementById('budgetInput').disabled = true;
        document.getElementById('saveBudgetBtn').disabled = true;
      }

      // Load initial data
      loadExpenses();
      loadMembers();
      
      // Hide mobile menu button on large screens
      checkScreenSize();
      window.addEventListener('resize', checkScreenSize);
    });

    function checkScreenSize() {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      if (window.innerWidth > 768) {
        mobileMenuBtn.style.display = 'none';
      } else {
        mobileMenuBtn.style.display = 'block';
      }
    }

    // =============================
    // Load Household Members
    // =============================
    async function loadMembers() {
      try {
        const res = await api('/api/members');
        if (!res) return;

        const membersList = document.getElementById('membersList');
        membersList.innerHTML = '';

        if (res.members && res.members.length > 0) {
          res.members.forEach(member => {
            const memberCard = document.createElement('div');
            memberCard.className = 'member-card';
            memberCard.innerHTML = `
              <strong>${member.display_name}</strong>
              ${member.is_admin ? '<span class="admin-badge">Admin</span>' : ''}
              <div style="font-size: 0.8rem; color: #666;">${member.email}</div>
            `;
            membersList.appendChild(memberCard);
          });
        } else {
          membersList.innerHTML = '<p>No members found</p>';
        }
      } catch (error) {
        console.error('Error loading members:', error);
      }
    }

    // =============================
    // Save Budget (Admin only)
    // =============================
    async function saveBudget() {
      try {
        const val = parseFloat(document.getElementById('budgetInput').value || 0);
        if (isNaN(val) || val <= 0) {
          alert('Please enter a valid budget amount');
          return;
        }

        const res = await api('/api/budget', { 
          method: 'POST', 
          body: JSON.stringify({amount: val})
        });
        
        if (res) {
          alert('Budget saved successfully!');
          document.getElementById('budgetInput').value = '';
          // Update the UI with new budget values
          document.getElementById('budget').textContent = `₹${val}`;
          // Recalculate remaining
          const totalSpent = parseFloat(document.getElementById('totalSpent').textContent.replace('₹', ''));
          const remaining = val - totalSpent;
          document.getElementById('remaining').textContent = `₹${remaining.toFixed(2)}`;
        }
      } catch (error) {
        console.error('Error saving budget:', error);
        if (error.message.includes('403')) {
          alert('Only admins can set the budget');
        } else {
          alert('Error saving budget. Please try again.');
        }
      }
    }

    // =============================
    // Add Expense
    // =============================
    async function addExpense() {
      try {
        const item = document.getElementById('item').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        const category = document.getElementById('category').value.trim();
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;

        if (!item || isNaN(amount) || amount <= 0) {
          alert('Please enter a valid item and amount');
          return;
        }

        const payload = { item, amount, category, date, time };

        const res = await api('/api/expense', { 
          method: 'POST', 
          body: JSON.stringify(payload)
        });

        if (res) {
          alert('Expense added successfully!');
          // Reset form
          document.getElementById('item').value = '';
          document.getElementById('amount').value = '';
          document.getElementById('category').value = '';
          
          // Reload expenses
          loadExpenses();
        }
      } catch (error) {
        console.error('Error adding expense:', error);
        alert('Error adding expense. Please try again.');
      }
    }

    // =============================
    // Load Expenses
    // =============================
    async function loadExpenses() {
      try {
        const res = await api('/api/expenses');
        if (!res) return;

        const tbody = document.querySelector('#table tbody');
        const noExpenses = document.getElementById('noExpenses');
        tbody.innerHTML = '';

        if (res.expenses && res.expenses.length > 0) {
          noExpenses.style.display = 'none';
          res.expenses.forEach(expense => {
            const tr = document.createElement('tr');
            
            // Format shares information
            const sharesInfo = expense.shares.map(share => 
              `${share.display_name}: ₹${share.share_amount}`
            ).join(', ');
            
            tr.innerHTML = `
              <td>${expense.item}</td>
              <td>₹${expense.amount}</td>
              <td>${expense.payer_name}</td>
              <td>${expense.date}</td>
              <td>${expense.time}</td>
              <td>${sharesInfo}</td>
            `;
            tbody.appendChild(tr);
          });

          // Update total spent display
          document.getElementById('totalSpent').textContent = `₹${res.total.toFixed(2)}`;
          
          // Update remaining budget
          const budget = parseFloat(document.getElementById('budget').textContent.replace('₹', ''));
          const remaining = budget - res.total;
          document.getElementById('remaining').textContent = `₹${remaining.toFixed(2)}`;
        } else {
          noExpenses.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading expenses:', error);
        document.getElementById('noExpenses').style.display = 'block';
        document.getElementById('noExpenses').innerHTML = `
          <i class="fas fa-exclamation-triangle" style="font-size:2rem;color:#ffc107;margin-bottom:10px"></i>
          <p style="color:#666">Error loading expenses. Please refresh the page.</p>
        `;
      }
    }

    // =============================
    // Download Report
    // =============================
    function download(period) {
      window.location.href = `/api/report/${period}`;
    }

    // =============================
    // Copy Invite Code
    // =============================
    function copyInviteCode() {
      const inviteCode = document.getElementById('inviteCode').textContent;
      navigator.clipboard.writeText(inviteCode).then(() => {
        // Show feedback
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
          button.innerHTML = originalText;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy invite code. Please copy it manually.');
      });
    }
  </script>
</body>
</html>